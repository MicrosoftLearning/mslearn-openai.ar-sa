---
lab:
  title: تنفيذ استرداد الجيل المعزز (RAG) باستخدام خدمة Azure OpenAI
---

# تنفيذ استرداد الجيل المعزز (RAG) باستخدام خدمة Azure OpenAI

تمكنك خدمة Azure OpenAI من استخدام بياناتك الخاصة مع ذكاء LLM الأساسي. يمكنك تقييد النموذج لاستخدام بياناتك فقط للمواضيع ذات الصلة، أو مزجها مع النتائج من النموذج المدرب مسبقاً.

في سيناريو هذا التمرين، ستؤدي دور مطور برامج يعمل لدى Margie's Travel Agency. ستستكشف كيفية استخدام الذكاء الاصطناعي التوليدي لجعل مهام الترميز أسهل وأكثر كفاءة. يمكن تطبيق التقنيات المستخدمة في التمرين على ملفات التعليمات البرمجية الأخرى ولغات البرمجة وحالات الاستخدام.

سيستغرق هذا التدريب حوالي **20** دقيقة.

## توفير مورد Azure OpenAI

إذا لم يكن لديك مورداً بالفعل، فيمكنك توفير مورد Azure OpenAI في اشتراك Azure الخاص بك.

1. سجّل الدخول إلى **Azure portal** من `https://portal.azure.com`.
2. إنشاء مورد **Azure OpenAI** بالإعدادات التالية:
    - **اشتراك**: *حدد اشتراك Azure الذي جرت الموافقة عليه للوصول إلى خدمة Azure OpenAI*
    - **مجموعة الموارد**: *اختيار مجموعة موارد أو إنشاءها*
    - **المنطقة**: *إجراء اختيار **عشوائي** من أي من المناطق التالية*\*
        - شرق أستراليا
        - شرق كندا
        - شرق الولايات المتحدة
        - East US 2
        - وسط فرنسا
        - شرق اليابان
        - وسط شمال الولايات المتحدة
        - منطقة السويد الوسطى
        - شمال سويسرا
        - جنوب المملكة المتحدة
    - **الاسم**: *اسم فريد من اختيارك*
    - **مستوى التسعير**: قياسي S0

    > \* موارد Azure OpenAI مقيدة بالحصص النسبية الإقليمية. تتضمن المناطق المدرجة الحصة النسبية الافتراضية لنوع (أنواع) النموذج المستخدمة في هذا التمرين. يؤدي اختيار منطقة عشوائيًا إلى تقليل مخاطر وصول منطقة واحدة إلى حد الحصة النسبية في السيناريوهات التي تشارك فيها اشتراكًا مع مستخدمين آخرين. في حالة الوصول إلى حد الحصة النسبية لاحقًا في التمرين، هناك احتمال أنك قد تحتاج إلى إنشاء مورد آخر في منطقة مختلفة.

3. يُرجى الانتظار لاكتمال التوزيع. ثم انتقل إلى مورد Azure OpenAI الموزّع في مدخل Microsoft Azure.

## توزيع النموذج

يوفر Azure OpenAI مدخلاً مستنداً إلى الويب يسمى **Azure OpenAI Studio**، يمكنك استخدامه لنشر النماذج وإدارتها واستكشافها. ستبدأ استكشافك لـ Azure OpenAI باستخدام Azure OpenAI Studio لتوزيع نموذج.

1. في صفحة **نظرة عامة** لمورد Azure OpenAI، استخدم زر **انتقل إلى Azure OpenAI Studio** لفتح Azure OpenAI Studio في علامة تبويب مستعرض جديدة.
2. في Azure OpenAI Studio، في صفحة **عمليات التوزيع**، اعرض عمليات توزيع النموذج الحالية. إذا لم يكن لديك واحدة بالفعل، فعليك إنشاء توزيع جديد لنموذج **gpt-35-turbo-16k** بالإعدادات التالية:
    - **النموذج**: gpt-35-turbo-16k *(يجب أن يكون هذا النموذج لاستخدام الميزات في هذا التمرين)*
    - **إصدار النموذج**: Auto-update to default
    - **اسم التوزيع**: *اسم فريد من اختيارك. وستستخدم هذا الاسم لاحقاً في المعمل.*
    - **خيارات متقدمة**
        - **عامل تصفية المحتوى**: افتراضية
        - **نوع التوزيع**: قياسي
        - **حد معدل الرموز المميزة في الدقيقة**: 5K\*
        - **تمكين الحصة النسبية الديناميكية**: تم التمكين

    > \*الحد الأقصى لمعدل 5000 رمز مميز في الدقيقة هو أكثر من كاف لإكمال هذا التمرين مع ترك سعة للأشخاص الآخرين الذين يستخدمون نفس الاشتراك.

## مراقبة سلوك الدردشة العادي دون إضافة بياناتك الخاصة

قبل توصيل Azure OpenAI ببياناتك، لنراقب أولاً كيفية استجابة النموذج الأساسي للاستعلامات دون أي بيانات أساسية.

1. في **Azure OpenAI Studio** في `https://oai.azure.com`، في قسم **بيئة تجريبية**، حدد صفحة **دردشة**. تتكون صفحة بيئة **الدردشة** التجريبية من ثلاثة أقسام رئيسية:
    - **إعداد** - يستخدم لتعيين سياق استجابات النموذج.
    - **جلسة الدردشة** - تستخدم لإرسال رسائل الدردشة وعرض الاستجابات.
    - **تكوين** - يستخدم لتكوين إعدادات نشر النموذج.
2. في جزء **تكوين**، تأكد من تحديد توزيع النموذج الخاص بك.
3. في منطقة **إعداد**، حدد قالب رسالة النظام الافتراضي لتعيين سياق جلسة الدردشة. رسالة النظام الافتراضي هي *أنك مساعد الذكاء الاصطناعي وتعمل على مساعدة الأشخاص على العثور على المعلومات*.
4. في **جلسة الدردشة**، أرسل الاستعلامات التالية، وراجع الاستجابات:

    ```prompt
    I'd like to take a trip to New York. Where should I stay?
    ```

    ```prompt
    What are some facts about New York?
    ```

    جرب أسئلة مماثلة عن السياحة والأماكن للبقاء في مواقع أخرى ستضم في البيانات الأساسية الخاصة بنا، مثل لندن أو سان فرانسيسكو. من المحتمل أن تحصل على استجابات كاملة حول المناطق أو الأحياء وبعض الحقائق العامة حول المدينة.

## توصيل بياناتك في بيئة الدردشة النجريبية

الآن ستضيف بعض البيانات لشركة وكلاء سفر خيالية تسمى *Margie's Travel*. ثم سترى كيف يستجيب نموذج Azure OpenAI عند استخدام الكتيبات من Margie's Travel كبيانات أساسية.

1. في علامة تبويب مستعرض جديدة، يمكنك تنزيل أرشيف بيانات الكتيب من `https://aka.ms/own-data-brochures`. استخرج الكتيبات إلى مجلد على جهاز الكمبيوتر الخاص بك.
1. في Azure OpenAI Studio، في بيئة **الدردشة** التجريبية، في قسم **الإعداد**، حدد **إضافة بياناتك**.
1. حدد **إضافة مصدر بيانات** واختر **تحميل الملفات**.
1. ستحتاج إلى إنشاء حساب تخزين ومورد بحث الذكاء الاصطناعي في Azure. ضمن القائمة المنسدلة لمورد التخزين، حدد **إنشاء مورد تخزين كائن ثنائي كبير الحجم من Azure** وأنشئ حساب تخزين بالإعدادات التالية. أي شيء لم يحدد يترك كإعداد افتراضي.

    - **Subscription**: *اشتراكك في Azure*
    - **مجموعة الموارد**: *تحديد نفس مجموعة الموارد كمورد Azure OpenAI الخاص بك*
    - **اسم حساب التخزين**: *أدخل اسماً فريداً*
    - **المنطقة**: *تحديد نفس المنطقة كمورد Azure OpenAI الخاص بك*
    - **التكرار**: التخزين المتكرر محلياً (LRS)

1. خلال إنشاء مورد حساب التخزين، ارجع إلى Azure OpenAI Studio وحدد **إنشاء مورد بحث الذكاء الاصطناعي في Azure** بالإعدادات التالية. أي شيء لم يحدد يترك كإعداد افتراضي.

    - **Subscription**: *اشتراكك في Azure*
    - **مجموعة الموارد**: *تحديد نفس مجموعة الموارد كمورد Azure OpenAI الخاص بك*
    - **اسم الخدمة**: *أدخل اسماً فريداً*
    - **الموقع**: *تحديد الموقع نفسه كمورد Azure OpenAI الخاص بك*
    - **مستوى التسعير**: أساسي

1. انتظر حتى توزيع مورد البحث، ثم عليك التبديل مرة أخرى إلى Azure AI Studio.
1. في **إضافة بيانات**، أدخل القيم التالية لمصدر البيانات، ثم حدد **التالي**.

    - **تحديد مصدر البيانات**: تحميل الملفات
    - **اشتراك**: اشتراكك في Azure
    - **تحديد مورد تخزين كائن ثنائي كبير الحجم من Azure**: *استخدم زر **التحديث** لإعادة ملء القائمة، ثم اختر مورد التخزين الذي أنشأته*
        - تشغيل CORS عند مطالبتك
    - **تحديد مورد بحث الذكاء الاصطناعي في Azure**: *استخدم زر **التحديث** لإعادة ملء القائمة، ثم اختر مورد البحث الذي أنشأته*
    - **أدخل اسم الفهرس**: `margiestravel`
    - **إضافة بحث متجه إلى مورد البحث هذا**: غير محدد
    - **أقر بأن الاتصال بحساب بحث الذكاء الاصطناعي في Azure سيتحمل الاستخدام إلى حسابي** : محدد

1. في صفحة **تحميل الملفات**، يمكنك تحميل ملفات PDF التي نزلتها، ثم حدد **التالي**.
1. في صفحة **إدارة البيانات**، حدد نوع البحث عن **الكلمة الأساسية** من القائمة المنسدلة، ثم حدد **التالي**.
1. في صفحة **المراجعة والانتهاء**، حدد **حفظ وإغلاق**، ما سيؤدي إلى إضافة بياناتك. قد يستغرق ذلك بضع دقائق، تحتاج خلالها إلى ترك نافذتك مفتوحة. بمجرد الانتهاء، سترى مصدر البيانات ومورد البحث والفهرس المحدد في قسم **الإعداد**.

    > **تلميح**: أحياناً يستغرق الاتصال بين فهرس البحث الجديد وAzure OpenAI Studio وقتاً طويلاً. إذا انتظرت بضع دقائق ولم ينجح التوصيل بعد، فتحقق من موارد بحث الذكاء الاصطناعي في مدخل Azure. إذا رأيت الفهرس المكتمل، فيمكنك قطع اتصال البيانات في Azure OpenAI Studio وإعادة إضافته عن طريق تحديد مصدر بيانات بحث الذكاء الاصطناعي في Azure وتحديد فهرسك الجديد.

## الدردشة مع نموذج مستند إلى بياناتك

الآن بعد أن أضفت بياناتك، اطرح الأسئلة نفسها كما فعلت سابقاً، وشاهد كيف تختلف الاستجابة.

```prompt
I'd like to take a trip to New York. Where should I stay?
```

```prompt
What are some facts about New York?
```

ستلاحظ رداً مختلفاً جداً هذه المرة، مع تفاصيل حول بعض الفنادق وإشارة إلى Margie's Travel، بالإضافة إلى الإشارات إلى المكان الذي جاءت منه المعلومات المقدمة. إذا فتحت مرجع PDF المدرج في الاستجابة، فسترى الفنادق نفسها التي يوفرها النموذج.

حاول أن تسأله عن المدن الأخرى المضمنة في البيانات الأساسية، وهي دبي ولاس فيغاس ولندن وسان فرانسيسكو.

> **ملاحظة**: لا تزال **إضافة بياناتك** قيد المعاينة وقد لا تتصرف دائماً كما هو متوقع لهذه الميزة، مثل إعطاء مرجع غير صحيح لمدينة غير مضمنة في البيانات الأساسية.

## توصيل تطبيقك ببياناتك الخاصة

بعد ذلك، لنستكشف كيفية توصيل تطبيقك لاستخدام بياناتك الخاصة.

### الاستعداد لتطوير تطبيق في تعليمة Visual Studio البرمجية

لنستكشف الآن استخدام بياناتك الخاصة في تطبيق يستخدم SDK لخدمة Azure OpenAI. ستقوم بتطوير تطبيقك باستخدام تعليمة Visual Studio البرمجية. تم توفير ملفات التعليمات البرمجية لتطبيقك في مستودع GitHub.

> **تلميح**: إذا نسخت بالفعل مستودع **mslearn-openai**، فافتحه في تعليمة Visual Studio البرمجية. وإلا فاتبع هذه الخطوات لاستنساخه إلى بيئة تطويرك.

1. ابدأ تشغيل Visual Studio Code.
2. افتح لوحة (SHIFT+CTRL+P) وشغّل **Git: استنسخ الأمر ** لاستنساخ مستودع `https://github.com/MicrosoftLearning/mslearn-openai` إلى مجلد محلي (لا يُهم أي مجلد).
3. عند استنساخ المستودع، افتح المجلد في تعليمة Visual Studio البرمجية.

    > **ملاحظة**: إذا عرضت لك تعليمة Visual Studio البرمجية رسالة منبثقة لمطالبتك بالثقة في التعليمات البرمجية التي تفتحها، فانقر فوق **نعم، أثق في خيار الكُتاب** في النافذة المنبثقة.

4. انتظر حتى تثبيت ملفات إضافية لدعم مشاريع التعليمات البرمجية C# في المستودع.

    > **ملاحظة**: في حالة مطالبتك بإضافة الأصول المطلوبة للبناء وتصحيح الأخطاء، فحدد **ليس الآن**.

## تكوين تطبيقك

التطبيقات لكل من C# وPython متوفرة، ويمتلك كلا التطبيقين الوظيفة نفسها. أولاً، ستكمل بعض الأجزاء الرئيسية من التطبيق لتمكين استخدام مورد Azure OpenAI الخاص بك.

1. في تعليمة Visual Studio البرمجية في جزء **المستكشف**، انتقِل إلى المجلد **Labfiles/06-use-own-data** وعليك توسيع المجلد **CSharp** أو **Python** حسب تفضيل اللغة لديك. يحتوي كل مجلد على الملفات الخاصة باللغة للتطبيق الذي ستدمج وظيفة Azure OpenAI فيه.
2. انقر بزر الماوس الأيمن فوق المجلد **CSharp** أو **Python** الذي يحتوي على ملفات التعليمات البرمجية الخاصة بك وافتح محطة طرفية متكاملة. ثم، عليك تثبيت حزمة Azure OpenAI SDK عن طريق تشغيل الأمر المناسب لتفضيل اللغة لديك:

    **C#:**

    ```
    dotnet add package Azure.AI.OpenAI --version 1.0.0-beta.14
    ```

    **Python**:

    ```
    pip install openai==1.13.3
    ```

3. في جزء**مستكشف**، في مجلد **CSharp** أو **Python**، افتح ملف التكوين للغة المفضلة لديك

    - **C#**: appsettings.json
    - **Python**: .env
    
4. تحديث قيم التكوين لتشمل:
    - **نقطة النهاية** و**مفتاح** من مورد Azure OpenAI الذي أنشأته (متوفر في صفحة **المفاتيح ونقطة النهاية** لمورد Azure OpenAI الخاص بك في مدخل Azure)
    - **اسم التوزيع** الذي حددته لنشر النموذج الخاص بك (متوفر في صفحة **عمليات التوزيع** في Azure OpenAI Studio).
    - نقطة النهاية لخدمة البحث الخاصة بك (قيمة عنوان **URL** في صفحة النظرة العامة لمورد البحث الخاص بك في مدخل Azure).
    - **مفتاح** لمورد البحث لديك (متوفر في صفحة **المفاتيح** لمورد البحث في مدخل Azure - يمكنك استخدام أي من مفاتيح المسؤول)
    - اسم فهرس البحث (الذي يجب أن يكون `margiestravel`).
1. احفظ ملف التكوين.

### أضف تعليمات برمجية لاستخدام خدمة Azure OpenAI

أنت الآن جاهز لاستخدام Azure OpenAI SDK لاستهلاك نموذجك الموزع.

1. في جزء **مستكشف**، في المجلد **CSharp** أو **Python**، افتح ملف التعليمات البرمجية للغتك المفضلة، واستبدل التعليق ***تكوين مصدر البيانات الخاص بك*** باستخدام التعليمة البرمجية لإضافة مكتبة Azure OpenAI SDK:

    **C#**: ownData.cs

    ```csharp
    // Configure your data source
    AzureSearchChatExtensionConfiguration ownDataConfig = new()
    {
            SearchEndpoint = new Uri(azureSearchEndpoint),
            Authentication = new OnYourDataApiKeyAuthenticationOptions(azureSearchKey),
            IndexName = azureSearchIndex
    };
    ```

    **Python**: ownData.py

    ```python
    # Configure your data source
    extension_config = dict(dataSources = [  
            { 
                "type": "AzureCognitiveSearch", 
                "parameters": { 
                    "endpoint":azure_search_endpoint, 
                    "key": azure_search_key, 
                    "indexName": azure_search_index,
                }
            }]
        )
    ```

2. راجع بقية التعليمة البرمجية، مع ملاحظة استخدام *الملحقات* في نص الطلب المستخدم لتوفير معلومات عن إعدادات مصدر البيانات.

3. احفظ التغييرات في ملف التعليمة البرمجية.

## تشغيل التطبيق الخاص بك

الآن بعد أن نجح تكوين التطبيق الخاص بك، عليك تشغيله لإرسال طلبك إلى النموذج الخاص بك ومراقبة الاستجابة. ستلاحظ أن الفرق الوحيد بين الخيارات المختلفة هو محتوى المطالبة، وتظل جميع المعلمات الأخرى (مثل عدد الرموز المميزة ودرجة الحرارة) كما هي لكل طلب.

1. في جزء الوحدة الطرفية التفاعلية، تأكد من أن سياق المجلد هو المجلد الخاص باللغة المفضلة لديك. ثم أدخل الأمر التالي لتشغيل التطبيق.

    - **C#:** `dotnet run`
    - **Python**: `python ownData.py`

    > **تلميح**: يمكنك استخدام أيقونة **تكبير حجم اللوحة** (**^**) في شريط أدوات المحطة الطرفية لرؤية المزيد من نص وحدة التحكم.

2. راجع الاستجابة إلى المطالبة `Tell me about London`، والتي يجب أن تتضمن إجابة بالإضافة إلى بعض التفاصيل عن البيانات المستخدمة لفصل المطالبة، والتي جرى الحصول عليها من خدمة البحث الخاصة بك.

    > **تلميح**: إذا أردت رؤية الاقتباسات من فهرس البحث، فعليك تعيين اقتباسات إظهار المتغير ***بالقرب*** من أعلى ملف التعليمات البرمجية على **صحيح**.

## تنظيف

عند الانتهاء من مورد Azure OpenAI، تذكر حذف المورد بأكمله في **مدخل Azure** في `https://portal.azure.com`. تأكد أيضاً من تضمين حساب التخزين ومورد البحث، حيث يمكن أن يؤدي ذلك إلى تكلفة كبيرة نسبياً.
