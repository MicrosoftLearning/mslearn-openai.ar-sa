---
lab:
  title: تنفيذ استرداد الجيل المعزز (RAG) باستخدام خدمة Azure OpenAI
  status: new
---

# تنفيذ استرداد الجيل المعزز (RAG) باستخدام خدمة Azure OpenAI

تمكنك خدمة Azure OpenAI من استخدام بياناتك الخاصة مع ذكاء LLM الأساسي. يمكنك تقييد النموذج لاستخدام بياناتك فقط للمواضيع ذات الصلة، أو مزجها مع النتائج من النموذج المدرب مسبقاً.

في سيناريو هذا التمرين، ستؤدي دور مطور برامج يعمل لدى Margie's Travel Agency. ستكتشف كيفية استخدام بحث الذكاء الاصطناعي في Azure لفهرسة بياناتك واستخدامها مع Azure OpenAI لزيادة المطالبات.

سيستغرق هذا التدريب حوالي **30** دقيقة.

## تزويد موارد Azure

لإكمال هذا التدريب، ستحتاج إلى:

- مورد Azure OpenAI.
- مورد بحث الذكاء الاصطناعي في Azure
- مورد حساب تخزين Azure.

1. سجّل الدخول إلى **Azure portal** من `https://portal.azure.com`.
2. إنشاء مورد **Azure OpenAI** بالإعدادات التالية:
    - **اشتراك**: *حدد اشتراك Azure الذي جرت الموافقة عليه للوصول إلى خدمة Azure OpenAI*
    - **مجموعة الموارد**: *اختيار مجموعة موارد أو إنشاءها*
    - **المنطقة**: *إجراء اختيار **عشوائي** من أي من المناطق التالية*\*
        - شرق الولايات المتحدة
        - East US 2
        - وسط شمال الولايات المتحدة
        - South Central US
        - منطقة السويد الوسطى
        - غرب الولايات المتحدة
        - غرب الولايات المتحدة الأمريكية 3
    - **الاسم**: *اسم فريد من اختيارك*
    - **مستوى التسعير**: قياسي S0

    > \* موارد Azure OpenAI مقيدة بالحصص النسبية الإقليمية. تتضمن المناطق المدرجة الحصة النسبية الافتراضية لنوع (أنواع) النموذج المستخدمة في هذا التمرين. يؤدي اختيار منطقة عشوائيًا إلى تقليل مخاطر وصول منطقة واحدة إلى حد الحصة النسبية في السيناريوهات التي تشارك فيها اشتراكًا مع مستخدمين آخرين. في حالة الوصول إلى حد الحصة النسبية لاحقًا في التمرين، هناك احتمال أنك قد تحتاج إلى إنشاء مورد آخر في منطقة مختلفة.

3. أثناء توفير مورد Azure OpenAI، قم بإنشاء **مورد بحث بالذكاء الاصطناعي في Azure** بالإعدادات التالية:
    - **الاشتراك**: *الاشتراك الذي قمت بتوفير مورد Azure OpenAI فيه*
    - **مجموعة الموارد**: *مجموعة الموارد التي وفرت مورد Azure OpenAI الخاص بك فيها*
    - **الاسم الخدمة**: *اسم فريد من اختيارك*
    - **الموقع**: *المنطقة التي وفرت مورد Azure OpenAI الخاصة بك فيها*
    - **مستوى التسعير**: أساسي
4. أثناء توفير مورد بحث الذكاء الاصطناعي في Azure، قم بإنشاء مورد **حساب تخزين** بالإعدادات التالية:
    - **الاشتراك**: *الاشتراك الذي قمت بتوفير مورد Azure OpenAI فيه*
    - **مجموعة الموارد**: *مجموعة الموارد التي وفرت مورد Azure OpenAI الخاص بك فيها*
    - **اسم حساب التخزين**: *اسم فريدمن اختيارك*
    - **المنطقة**: *المنطقة التي وفرت موارد Azure OpenAI الخاصة بك فيها*
    - **الخدمة الأساسية**: تخزين Azure الكائن الثنائي كبير الحجم BLOB أوAzure Data Lake Storage Gen 2
    - **الأداء:** قياسي
    - **التكرار**: التخزين المتكرر محليًا (LRS)
5. بعد توزيع جميع الموارد الثلاثة بنجاح في اشتراك Azure، راجعها في بوابة Azure واجمع المعلومات التالية (التي ستحتاج إليها لاحقًا في التدريب):
    - **نقطة النهاية** و**مفتاح** من مورد Azure OpenAI الذي أنشأته (متوفر في صفحة **المفاتيح ونقطة النهاية** لمورد Azure OpenAI الخاص بك في مدخل Microsoft Azure)
    - نقطة النهاية لخدمة البحث بالذكاء الاصطناعي في Azure الخاصة بك (قيمة عنوان **URL** في صفحة النظرة العامة لمورد البحث بالذكاء الاصطناعي في Azure في بوابة Azure).
    - يكون **مفتاح المسؤول الأساسي** لمورد البحث بالذكاء الاصطناعي في Azure (متوفر في صفحة **المفاتيح** لمورد البحث بالذكاء الاصطناعي في Azure في بوابة Azure).

## تحميل بياناتك

ستقوم بإبطال المطالبات التي تستخدمها مع نموذج الذكاء الاصطناعي التوليدي باستخدام بياناتك الخاصة. في هذا التدريب، تتكون البيانات من مجموعة من كتيبات السفر من شركة *Margies Travel* الخيالية.

1. في علامة تبويب مستعرض جديدة، يمكنك تنزيل أرشيف بيانات الكتيب من `https://aka.ms/own-data-brochures`. استخرج الكتيبات إلى مجلد على جهاز الكمبيوتر الخاص بك.
1. في بوابة Azure، انتقل إلى حساب التخزين الخاص بك، وقم بعرض صفحة **مستعرض التخزين**
1. حدد **حاويات الكائن الثنائي كبير الحجم** ثم أضف حاوية جديدة باسم `margies-travel`.
1. حدد حاوية**margies-travel**، ثم قم بتحميل الكتيبات بتنسيق .pdf التي قمت باستخراجها مسبقًا إلى المجلد الجذر لحاوية الكائن الثنائي كبير الحجم.

## توزيع نماذج الذكاء الاصطناعي

ستستخدم نموذجين للذكاء الاصطناعي في هذا التدريب:

- نص يتضمن نموذج *لتحويل* النص في الكتيبات إلى رموز بحيث يمكن فهرسته بكفاءة للاستخدام في المطالبات الأساسية.
- نموذج GPT الذي يمكن لتطبيقك استخدامه لإنشاء استجابات للمطالبات المستندة إلى بياناتك.

## توزيع النموذج

بعد ذلك، ستقوم بتوزيع نماذج Azure OpenAI من Cloud Shell.

1. استخدم الزر **[\>_]** الموجود على يمين شريط البحث أعلى الصفحة لإنشاء Cloud Shell جديد في بوابة Azure، وتحديد بيئة ***Bash***. يوفّر Cloud Shell واجهة سطر أوامر في جزء أسفل بوابة Azure.

    > **ملاحظة**: إذا كنت قد أنشأت مسبقًا Cloud Shell يستخدم بيئة *PowerShell*، فبدّل إلى ***Bash***.

```dotnetcli
az cognitiveservices account deployment create \
   -g <your_resource_group> \
   -n <your_OpenAI_resource> \
   --deployment-name text-embedding-ada-002 \
   --model-name text-embedding-ada-002 \
   --model-version "2"  \
   --model-format OpenAI \
   --sku-name "Standard" \
   --sku-capacity 5
```

> **ملاحظة**: يتم قياس سعة Sku بالآلاف من الرموز المميزة في الدقيقة. حد المعدل البالغ 5,000 رمز في الدقيقة يُعد كافيًا تمامًا لإكمال هذا التمرين، مع ترك سعة متاحة لمستخدمين آخرين ضمن نفس الاشتراك.

بعد نشر نموذج تضمين النصوص، أنشئ عملية نشر جديدة لنموذج **gpt-4o** بالإعدادات التالية:

```dotnetcli
az cognitiveservices account deployment create \
   -g <your_resource_group> \
   -n <your_OpenAI_resource> \
   --deployment-name gpt-4o \
   --model-name gpt-4o \
   --model-version "2024-05-13" \
   --model-format OpenAI \
   --sku-name "Standard" \
   --sku-capacity 5
```

## إنشاء فهرس

لتسهيل استخدام بياناتك الخاصة في مطالبة، ستقوم بفهرستها باستخدام البحث بالذكاء الاصطناعي في Azure. ستستخدم نموذج تضمين النص لتحويل بيانات النص إلى *متجهات* (مما يؤدي إلى تمثيل كل رمز مميّز نصي في الفهرس بواسطة متجهات رقمية - مما يجعله متوافقًا مع الطريقة التي يمثل بها نموذج الذكاء الاصطناعي التوليدي النص)

1. في بوابة Azure، انتقل إلى مورد البحث بالذكاء الاصطناعي في Azure.
1. ثم، في صفحة **نظرة عامة** حدد **استيراد البيانات ثم حوّل البيانات إلى رموز**.
1. في صفحة **إعداد اتصال البيانات**، حدد **تخزين الكائن الثنائي كبير الحجم في Azure** وقم بتكوين مصدر البيانات بالإعدادات التالية:
    - **الاشتراك**: اشتراك Azure الذي قمت بتوفير حساب التخزين الخاص بك فيه.
    - **حساب تخزين الكائن الثنائي كبير الحجم**: حساب التخزين الذي قمت بإنشائه سابقًا.
    - **حاوية الكائن الثنائي كبير الحجم**: margies-travel
    - **مجلد الكائن الثنائي كبير الحجم**: *اترك هذا فارغًا*
    - **تمكين تعقب الحذف**: إلغاء التحديد
    - **المصادقة باستخدام الهوية المُدارة**: إلغاء التحديد
1. في صفحة **تحويل نصك إلى رموز**، حدد الإعدادات التالية:
    - **النوع**: Azure OpenAI
    - **الاشتراك**: اشتراك Azure الذي قمت بتوفير خدمة Azure OpenAI الخاصة بك فيه.
    - **خدمة Azure OpenAI**: مورد خدمة Azure OpenAI الخاصة بك
    - **توزيع النموذج**: text-embedding-ada-002
    - **نوع المصادقة**: مفتاح API
    - **أقر بأن الاتصال بخدمة Azure OpenAI سيتكلف رسومًا إضافية على حسابي**: تحديد
1. في الصفحة التالية، **لا** تحدد خيار تحويل الصور إلى رموز أو استخراج البيانات باستخدام مهارات الذكاء الاصطناعي.
1. في الصفحة التالية، قم بتمكين الترتيب الدلالي وجدولة المفهرس للتشغيل مرة واحدة.
1. في الصفحة الأخيرة، قم بتعيين **بادئة اسم الغرض** إلى `margies-index` ثم قم بإنشاء الفهرس.

## الاستعداد لتطوير تطبيق في تعليمة Visual Studio البرمجية

لنستكشف الآن استخدام بياناتك الخاصة في تطبيق يستخدم SDK لخدمة Azure OpenAI. ستقوم بتطوير تطبيقك باستخدام تعليمة Visual Studio البرمجية. تم توفير ملفات التعليمات البرمجية لتطبيقك في مستودع GitHub.

> **تلميح**: إذا نسخت بالفعل مستودع **mslearn-openai**، فافتحه في تعليمة Visual Studio البرمجية. وإلا فاتبع هذه الخطوات لاستنساخه إلى بيئة تطويرك.

1. ابدأ تشغيل Visual Studio Code.
2. افتح لوحة الأوامر (SHIFT+CTRL+P أو **View** > **Command Palette...**)، ثم نفّذ أمر **Git: Clone** لاستنساخ المستودع `https://github.com/MicrosoftLearning/mslearn-openai` إلى مجلد محلي (لا يهم أي مجلد تختاره).
3. عند استنساخ المستودع، افتح المجلد في Visual Studio Code.

    > **ملاحظة**: إذا عرضت لك Visual Studio Code رسالة منبثقة لمطالبتك بالثقة في التعليمات البرمجية التي تفتحها، فانقر فوق **نعم، أثق في خيار الكُتاب** في النافذة المنبثقة.

4. انتظر حتى تثبيت ملفات إضافية لدعم مشاريع التعليمات البرمجية C# في المستودع.

    > **ملاحظة**: في حالة مطالبتك بإضافة الأصول المطلوبة للبناء وتصحيح الأخطاء، فحدد **ليس الآن**.

## تكوين تطبيقك

التطبيقات لكل من C# وPython متوفرة، ويمتلك كلا التطبيقين الوظيفة نفسها. أولاً، ستكمل بعض الأجزاء الرئيسية من التطبيق لتمكين استخدام مورد Azure OpenAI الخاص بك.

1. في Visual Studio Code، في جزء **المستكشف**، انتقل إلى المجلد **Labfiles/02-use-own-data** ووسّع نطاق المجلد **CSharp** أو **Python** وفقًا لتفضيلات اللغة الخاصة بك. يحتوي كل مجلد على الملفات الخاصة باللغة للتطبيق الذي ستدمج وظيفة Azure OpenAI فيه.
2. انقر بزر الماوس الأيمن فوق المجلد **CSharp** أو **Python** الذي يحتوي على ملفات التعليمات البرمجية الخاصة بك وافتح محطة طرفية متكاملة. ثم، عليك تثبيت حزمة Azure OpenAI SDK عن طريق تشغيل الأمر المناسب لتفضيل اللغة لديك:

    **C#:**

    ```powershell
    dotnet add package Azure.AI.OpenAI --version 2.1.0
    dotnet add package Azure.Search.Documents --version 11.6.0
    ```

    **Python**:

    ```powershell
    pip install openai==1.65.2
    ```

3. في جزء **مستكشف**، في مجلد **CSharp** أو **Python**، افتح ملف التكوين للغة المفضلة لديك

    - **C#**: appsettings.json
    - **Python**: .env

4. تحديث قيم التكوين لتشمل:
    - **نقطة النهاية** و**مفتاح** من مورد Azure OpenAI الذي أنشأته (متوفر في صفحة **المفاتيح ونقطة النهاية** لمورد Azure OpenAI الخاص بك في مدخل Microsoft Azure)
    - اسم **النشر** الذي حددته لنشر نموذج gpt-4o (يجب أن يكون `gpt-4o`).
    - نقطة النهاية لخدمة البحث الخاصة بك (قيمة عنوان **URL** في صفحة النظرة العامة لمورد البحث الخاص بك في مدخل Azure).
    - **مفتاح** لمورد البحث لديك (متوفر في صفحة **المفاتيح** لمورد البحث في مدخل Azure - يمكنك استخدام أي من مفاتيح المسؤول)
    - اسم فهرس البحث (الذي يجب أن يكون `margies-index`).
5. احفظ ملف التكوين.

### أضف تعليمات برمجية لاستخدام خدمة Azure OpenAI

أنت الآن جاهز لاستخدام Azure OpenAI SDK لاستهلاك نموذجك الموزع.

1. في جزء **Explorer**، داخل مجلد **CSharp** أو **Python**، افتح ملف الشيفرة للغة التي تفضلها، واستبدل التعليق ***تكوين مصدر بياناناتك*** باستخدام تعليمة برمجية تُعرّف الفهرس كمصدر بيانات لإكمال المحادثة:

    **C#**: ownData.cs

    ```csharp
    // Configure your data source
    // Extension methods to use data sources with options are subject to SDK surface changes. Suppress the warning to acknowledge this and use the subject-to-change AddDataSource method.
    #pragma warning disable AOAI001
    
    ChatCompletionOptions chatCompletionsOptions = new ChatCompletionOptions()
    {
        MaxOutputTokenCount = 600,
        Temperature = 0.9f,
    };
    
    chatCompletionsOptions.AddDataSource(new AzureSearchChatDataSource()
    {
        Endpoint = new Uri(azureSearchEndpoint),
        IndexName = azureSearchIndex,
        Authentication = DataSourceAuthentication.FromApiKey(azureSearchKey),
    });
    ```

    **Python**: ownData.py

    ```python
    # Configure your data source
    text = input('\nEnter a question:\n')
    
    completion = client.chat.completions.create(
        model=deployment,
        messages=[
            {
                "role": "user",
                "content": text,
            },
        ],
        extra_body={
            "data_sources":[
                {
                    "type": "azure_search",
                    "parameters": {
                        "endpoint": os.environ["AZURE_SEARCH_ENDPOINT"],
                        "index_name": os.environ["AZURE_SEARCH_INDEX"],
                        "authentication": {
                            "type": "api_key",
                            "key": os.environ["AZURE_SEARCH_KEY"],
                        }
                    }
                }
            ],
        }
    )
    ```

1. احفظ التغييرات في ملف التعليمة البرمجية.

## تشغيل التطبيق الخاص بك

الآن بعد أن نجح تكوين التطبيق الخاص بك، عليك تشغيله لإرسال طلبك إلى النموذج الخاص بك ومراقبة الاستجابة. ستلاحظ أن الفرق الوحيد بين الخيارات المختلفة هو محتوى المطالبة، وتظل جميع المعلمات الأخرى (مثل عدد الرموز المميزة ودرجة الحرارة) كما هي لكل طلب.

1. في جزء الوحدة الطرفية التفاعلية، تأكد من أن سياق المجلد هو المجلد الخاص باللغة المفضلة لديك. ثم أدخل الأمر التالي لتشغيل التطبيق.

    - **C#:** `dotnet run`
    - **Python**: `python ownData.py`

    > **تلميح**: يمكنك استخدام أيقونة **تكبير حجم اللوحة** (**^**) في شريط أدوات المحطة الطرفية لرؤية المزيد من نص وحدة التحكم.

2. راجع الاستجابة إلى المطالبة `Tell me about London`، والتي يجب أن تتضمن إجابة بالإضافة إلى بعض التفاصيل عن البيانات المستخدمة لفصل المطالبة، والتي جرى الحصول عليها من خدمة البحث الخاصة بك.

    > **تلميح**: إذا أردت رؤية الاقتباسات من فهرس البحث، فعليك تعيين اقتباسات إظهار المتغير ***بالقرب*** من أعلى ملف التعليمات البرمجية على **صحيح**.

## تنظيف

عند الانتهاء من مورد Azure OpenAI، تذكر أن تقوم بحذف المورد بأكمله في **بوابة Azure** على `https://portal.azure.com`. تأكد أيضاً من تضمين حساب التخزين ومورد البحث، حيث يمكن أن يؤدي ذلك إلى تكلفة كبيرة نسبياً.
